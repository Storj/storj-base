#! /usr/bin/env node
'use strict';
console.log('Starting up.')
const program = require('commander');
const shell = require('shelljs');
const entryPwd = shell.pwd().stdout

program
  .command('init [path]')
  .action(init)

program.parse(process.argv);

function init (path) {
  const pwd = shell.pwd().stdout
  path = path || '.'
  shell.cd(path)
  gitSubmoduleInit();
  gitSubmoduleUpdate();
  submodules().forEach(init)
  npmLinkSubmodules();
  shell.cd(pwd)
}

function gitSubmoduleInit(submodule) {
  submodule = submodule || '.';
  shell.exec('git submodule init ' + submodule)
}

function gitSubmoduleUpdate() {
  submodule = submodule || '.';
  shell.exec('git submodule update --remote ' + submodule)
}

function npmLinkSubmodules() {
  submodules().forEach(function(submodule) {
    shell.exec('cd ' + submodule + ' && npm link')
    shell.exec('cd ' + entryPwd + ' && npm link ' + submodule);
    // TODO: Check if module is already linked
    // Error if it is and it's a different refspect or commit hash
  })
}

function submodules() {
  return shell.exec('git submodule')
    .stdout.split('\n').map(function(line) {
      return line.match(/.\w+\s(\S+)/)[1];
    })
}
